# Implementation Plan: Live Query Service

**Branch**: `006-live-query-service` | **Date**: 2025-12-22 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/006-live-query-service/spec.md`

## Summary

Implement `LiveQueryService` that wraps the raw Mixpanel Query API methods in `MixpanelAPIClient` and transforms responses into structured result types (`SegmentationResult`, `FunnelResult`, `RetentionResult`, `JQLResult`). This service provides a clean interface for executing analytics queries with typed responses that support tabular (DataFrame) conversion.

## Technical Context

**Language/Version**: Python 3.11+ (type hints required throughout per constitution)
**Primary Dependencies**: httpx (HTTP client, already in use), Pydantic v2 (validation), pandas (DataFrame conversion)
**Storage**: N/A (live queries only, no local storage)
**Testing**: pytest with httpx.MockTransport for deterministic HTTP mocking
**Target Platform**: Library (PyPI package)
**Project Type**: Single project (existing `src/mixpanel_data/` structure)
**Performance Goals**: Query responses within 5 seconds for typical 30-day ranges (API-dependent)
**Constraints**: Rate limit of 60 queries/hour, max 5 concurrent queries (Mixpanel API limits)
**Scale/Scope**: 4 query types, 4 result types, 1 service class

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Library-First | ✅ Pass | Service is library component; CLI will wrap later |
| II. Agent-Native Design | ✅ Pass | Returns structured types, no interactive prompts |
| III. Context Window Efficiency | ✅ Pass | Returns precise typed results, supports DataFrame for analysis |
| IV. Two Data Paths | ✅ Pass | This is the "live queries" path per constitution |
| V. Explicit Over Implicit | ✅ Pass | No caching, no hidden state, dependency injection |
| VI. Unix Philosophy | ✅ Pass | Single responsibility: execute queries, transform responses |
| VII. Secure by Default | ✅ Pass | Uses existing credential system, no secret handling |

**Technology Stack Compliance**:
- ✅ Python 3.11+ with type hints
- ✅ httpx for HTTP (via existing API client)
- ✅ Pydantic v2 for validation (credentials)
- ✅ pandas for DataFrame conversion (existing result types)
- ✅ No new dependencies required

## Project Structure

### Documentation (this feature)

```text
specs/006-live-query-service/
├── plan.md              # This file
├── research.md          # API response transformation research
├── data-model.md        # Result type mapping
├── quickstart.md        # Usage examples
├── contracts/           # N/A (internal service, not external API)
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/mixpanel_data/
├── types.py                           # Result types (already exist)
├── _internal/
│   ├── api_client.py                  # Raw API methods (already exist)
│   └── services/
│       ├── __init__.py                # Add LiveQueryService export
│       ├── discovery.py               # Existing (pattern reference)
│       ├── fetcher.py                 # Existing (pattern reference)
│       └── live_query.py              # NEW: LiveQueryService implementation

tests/
├── conftest.py                        # Shared fixtures (mock_client_factory)
└── unit/
    ├── test_discovery.py              # Pattern reference
    └── test_live_query.py             # NEW: LiveQueryService tests
```

**Structure Decision**: Single project structure. New file `live_query.py` follows existing service patterns established by `discovery.py` and `fetcher.py`. No new directories needed.

## Complexity Tracking

> No constitution violations - no complexity tracking needed.

All design decisions align with established patterns:
- Constructor injection of `MixpanelAPIClient` (same as DiscoveryService)
- Return frozen dataclasses with lazy DataFrame conversion (existing pattern in types.py)
- Exception propagation without wrapping (same as existing services)
